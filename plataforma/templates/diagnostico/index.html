{% load static %}
<!DOCTYPE html>
<html lang="es" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico Participativo | Eduardo Herrera 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Space+Grotesk:wght@300;500;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --jp-red: #FF0000;
            --jp-green: #00FF41;
            --dark-pure: #000000;
        }

        body {
            background-color: var(--dark-pure);
            color: #FFFFFF;
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
        }

        .font-display {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .glow-red {
            background: radial-gradient(circle at center, rgba(255, 0, 0, 0.12) 0%, transparent 70%);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .option-card {
            transition: all 0.4s ease;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .option-card:hover {
            border-color: var(--jp-red);
            background: rgba(255, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--jp-red), var(--jp-green));
            width: 25%;
            transition: width 0.6s ease;
            box-shadow: 0 0 15px var(--jp-red);
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: slideUp 0.6s ease forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bg-dots {
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .alert-box {
            background: rgba(255, 0, 0, 0.1);
            border-left: 4px solid var(--jp-red);
        }
    </style>
</head>

<body class="bg-dots min-h-screen flex flex-col">
    <nav
        class="p-4 md:p-6 flex flex-col md:flex-row justify-between items-center relative z-50 max-w-7xl mx-auto w-full gap-4 md:gap-0">
        <div class="flex items-center w-full md:w-auto justify-center md:justify-start">
            <div
                class="bg-white/5 p-2 py-3 md:py-2 rounded-xl border border-white/10 w-full max-w-[280px] sm:max-w-[320px] md:max-w-[400px] flex justify-center">
                <img src="{% static 'images/JuntosPorElPeru.png' %}" alt="JP"
                    class="w-full h-auto object-contain max-h-16 md:max-h-20">
            </div>
        </div>
        <div
            class="px-4 py-1.5 rounded-full border border-white/10 bg-white/5 text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-widest text-center whitespace-nowrap">
            Plataforma Ciudadana
        </div>
    </nav>

    <main
        class="flex-1 flex flex-col lg:flex-row items-center justify-center p-4 relative max-w-7xl mx-auto w-full gap-8">
        <div class="absolute inset-0 glow-red z-0"></div>

        <!-- Columna Izquierda: Retrato del Candidato -->
        <div
            class="relative z-10 flex flex-1 flex-col justify-center items-center h-auto lg:h-[500px] xl:h-[600px] mb-8 lg:mb-0 transform lg:-translate-y-8 xl:-translate-y-10">
            <img src="{% static 'images/RetratoSinFondoCamisaBlancaConLogo.png' %}" alt="Eduardo Herrera"
                class="max-h-[300px] sm:max-h-[400px] lg:max-h-[520px] object-contain drop-shadow-[0_0_30px_rgba(255,0,0,0.3)] z-10">
            <div class="mt-4 text-center z-20">
                <h1
                    class="text-3xl sm:text-4xl xl:text-5xl font-extrabold font-display uppercase tracking-tight text-white drop-shadow-lg">
                    Eduardo <span class="text-red-600">Herrera</span>
                </h1>
                <p class="text-gray-400 font-bold tracking-[0.2em] uppercase text-[10px] sm:text-xs mt-1">Diputado por
                    el Callao</p>
                <div class="mt-6 flex items-center justify-center gap-4">
                    <a href="https://facebook.com/EduardoHerreraDiputadoPorElCallao" target="_blank"
                        class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-blue-600 hover:border-blue-600 transition-all shadow-lg">
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 320 512" aria-hidden="true">
                            <path d="M279.1 288l14.2-92.7h-88.7V135.3c0-25.4 12.2-50.1 52.1-50.1h40.5v-79.6C265 4.3 234.3 0 199.1 0 119.8 0 67.2 48.3 67.2 136.7v58.6H0V288h67.2v224h94.4V288h117.5z"/>
                        </svg>
                    </a>
                    <a href="https://tiktok.com/@eduardoherrera" target="_blank"
                        class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-black hover:border-black transition-all shadow-lg">
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 448 512" aria-hidden="true">
                            <path d="M448 209.91a210.06 210.06 0 0 1 -122.77-39.25v178.72A162.55 162.55 0 1 1 162.6 186.1v53.51a109.28 109.28 0 1 0 109.28 109.28V0h53.51a162.47 162.47 0 0 0 122.61 55.45z"/>
                        </svg>
                    </a>
                    <a href="https://wa.me/51954124774" target="_blank"
                        class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-green-500 hover:border-green-500 transition-all shadow-lg">
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 448 512" aria-hidden="true">
                            <path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 222.4-99.6 222.4-222.1 0-59.3-23.1-115-65.4-156.9zM224 415.8c-33 0-65.4-8.9-94-25.7l-6.7-4-69.8 18.3 18.7-68.1-4.4-7C49.8 296 41 260.4 41 224c0-101 82.2-183.1 183.1-183.1 48.9 0 94.9 19 129.5 53.6 34.6 34.6 53.6 80.6 53.6 129.6 0 101-82.1 183.2-183.2 183.2zM324.6 278.4c-5.5-2.8-32.5-16.1-37.5-17.9-5-1.9-8.7-2.8-12.4 2.8-3.7 5.5-14.2 17.9-17.5 21.6-3.2 3.7-6.5 4.1-11.9 1.4-5.5-2.8-23.2-8.6-44.2-27.4-16.4-14.7-27.5-32.8-30.7-38.3-3.2-5.5-.3-8.5 2.5-11.3 2.5-2.5 5.5-6.4 8.2-9.6 2.8-3.2 3.7-5.5 5.5-9.2 1.9-3.7.9-7-5.5-14.7-2.8-5.5-12.4-29.4-17-40.3-4.4-10.6-8.9-9.2-12.4-9.4-3.2-.2-6.5-.2-9.6-.2-3.2 0-8.7 1.2-13.3 6.9-4.6 5.6-17.9 17.5-17.9 42.6 0 25.1 18.3 49.3 20.9 52.8 2.5 3.5 36.1 55.1 87.5 77.3 12.2 5.3 21.8 8.4 29.3 10.8 12.3 3.9 23.5 3.3 32.4 2 10-1.4 32.5-13.3 37.1-26.1 4.6-12.8 4.6-23.8 3.2-26.1-1.3-2.3-5-3.6-10.5-6.4z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Formulario -->
        <div class="flex-1 w-full max-w-2xl glass-panel rounded-[40px] p-8 md:p-12 relative z-10 shadow-2xl">
            <!-- Barra de Progreso -->
            <div class="mb-10">
                <div class="flex justify-between items-end text-xs sm:text-sm font-bold uppercase text-gray-500 mb-3">
                    <div class="flex items-center gap-2">
                        <button type="button" onclick="restartForm()"
                            class="text-gray-400 hover:text-white transition-colors" title="Volver al inicio">
                            <i data-lucide="home" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                        </button>
                        <span>Diagnóstico Callao</span>
                    </div>
                    <span id="step-counter">Paso 1 de 4</span>
                </div>
                <div class="h-1 bg-white/10 rounded-full overflow-hidden">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
            </div>

            <!-- Paso 1 -->
            <div id="step-1" class="step active">
                <h2 class="text-3xl md:text-4xl font-extrabold mb-8 font-display italic leading-tight">¿Qué es lo
                    que
                    <span class="text-red-600">más te indigna</span> hoy del Callao?
                </h2>
                <div class="grid grid-cols-1 gap-4">
                    {% for tema in temas %}
                    <div class="option-card p-6 rounded-2xl bg-white/5 flex items-center justify-between group"
                        onclick="handleChoice('{{ tema.nombre }}')">
                        <div class="flex items-center gap-4">
                            <!-- Ícono dinámico basado en un loop o genérico por defecto -->
                            <i data-lucide="target" class="text-red-500 w-6 h-6"></i>
                            <span class="font-bold text-lg md:text-xl">{{ tema.nombre }}</span>
                        </div>
                        <i data-lucide="chevron-right"
                            class="w-5 h-5 text-gray-400 group-hover:text-white transition-colors"></i>
                    </div>
                    {% endfor %}
                    <!-- Opción Tema Libre -->
                    <div class="option-card p-6 rounded-2xl bg-white/5 flex items-center justify-between group"
                        onclick="handleChoice('Otros')">
                        <div class="flex items-center gap-4">
                            <i data-lucide="pen-tool" class="text-red-500 w-6 h-6"></i>
                            <span class="font-bold text-lg md:text-xl">Otro tema (Escribir)</span>
                        </div>
                        <i data-lucide="chevron-right"
                            class="w-5 h-5 text-gray-400 group-hover:text-white transition-colors"></i>
                    </div>
                </div>
            </div>

            <!-- Paso 2 -->
            <div id="step-2" class="step">
                <div class="alert-box p-6 rounded-2xl mb-8">
                    <h3 class="text-red-500 font-bold uppercase text-xs tracking-widest mb-2 flex items-center gap-2">
                        <i data-lucide="info" class="w-4 h-4"></i> El Congreso te está fallando
                    </h3>
                    <p id="sabotage-text" class="text-sm text-gray-300"></p>
                </div>
                <h2 id="p2-question" class="text-2xl font-bold mb-6 font-display italic"></h2>
                <div class="grid grid-cols-1 gap-4">
                    <div id="btn-opcion-si"
                        class="option-card p-5 rounded-xl bg-white/5 text-center font-bold text-lg md:text-xl"
                        onclick="nextStep(2)">
                        SÍ,
                        lo vivo a diario</div>
                    <div id="btn-opcion-no"
                        class="option-card p-5 rounded-xl bg-white/5 text-center font-bold text-lg md:text-xl"
                        onclick="showContextAndProceed()">
                        No
                        sabía que pasaba eso</div>
                </div>
            </div>

            <!-- Paso Intermedio (2.5) -->
            <div id="step-2-5" class="step">
                <div class="alert-box p-6 rounded-2xl mb-8">
                    <h3 class="text-red-500 font-bold uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="book-open" class="w-4 h-4 text-red-500"></i> Contexto
                    </h3>
                    <p id="context-no-text" class="text-base text-gray-300"></p>
                </div>
                <button
                    class="w-full bg-red-600 hover:bg-red-700 py-5 rounded-2xl font-bold uppercase shadow-xl transition-colors"
                    onclick="proceedFromContext()">Quiero más información</button>
            </div>

            <!-- Paso 3 -->
            <div id="step-3" class="step">
                <div class="bg-green-600/10 border-l-4 border-green-500 p-6 rounded-2xl mb-8">
                    <h3 class="text-green-500 font-bold uppercase text-xs tracking-widest mb-2">Mi Propuesta de Ley:
                    </h3>
                    <p id="proposal-text" class="text-lg font-bold text-white mb-2"></p>
                    <p id="proposal-impact" class="text-xs text-gray-400"></p>
                </div>
                <h2 class="text-2xl font-bold mb-6 font-display">¿Apoyarías esta como la <span
                        class="text-red-600 underline">primera acción</span> de Eduardo?</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div class="option-card p-5 rounded-xl bg-white/5 text-center font-bold" onclick="nextStep(3)">
                        APOYO
                        TOTAL</div>
                    <div class="option-card p-5 rounded-xl bg-white/5 text-center font-bold" onclick="nextStep(3)">
                        Quiero más información</div>
                </div>
            </div>

            <!-- Paso 4 -->
            <div id="step-4" class="step">
                <div class="text-center">
                    <h2 class="text-3xl font-extrabold mb-4 font-display italic">¡Bien, chalaco!</h2>
                    <p class="text-gray-400 mb-8 text-base italic">Plan sobre: <span id="summary-topic"
                            class="text-white font-bold"></span>.</p>
                    <div class="space-y-4">
                        <input type="text" id="custom-topic" placeholder="¿Cuál es tu tema propuesto?"
                            class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none hidden mb-4">
                        <input type="text" id="name" placeholder="Tu nombre y apellido"
                            class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none">
                        <input type="text" id="dni" placeholder="Tu número de DNI (opcional)" pattern="\d{8}"
                            maxlength="8" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none">
                        <input type="tel" id="phone" placeholder="WhatsApp"
                            class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none">
                        <button onclick="finish()"
                            class="w-full bg-red-600 py-4 hover:bg-red-700 transition-colors rounded-xl font-bold uppercase">Unirme
                            a la Brigada</button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>
    <script>
        lucide.createIcons();
        let userResponses = { topic: '', name: '', phone: '' };

        // Render contentMap from json context safely 
        // @ts-ignore
        const contentMap = {{ content_json| safe }};

        function handleChoice(val) {
            userResponses.topic = val;

            if (val === 'Otros') {
                // Tema Libre: saltar a la pantalla final directamente y mostrar input adicional
                document.getElementById('summary-topic').innerText = "TEMA PROPUESTO";
                document.getElementById('custom-topic').classList.remove('hidden');

                // Ocultar paso 1 y saltar al 4
                document.getElementById(`step-1`).classList.remove('active');
                document.getElementById(`step-4`).classList.add('active');
                document.getElementById('progress-fill').style.width = '100%';
                document.getElementById('step-counter').innerText = `Paso Final`;
                return;
            }

            const content = contentMap[val];
            if (content) {
                document.getElementById('sabotage-text').innerText = content.sabotage;
                document.getElementById('p2-question').innerText = content.question;
                document.getElementById('btn-opcion-si').innerText = content.opcion_si || "SÍ, lo vivo a diario";
                document.getElementById('btn-opcion-no').innerText = content.opcion_no || "No sabía que pasaba eso";
                document.getElementById('context-no-text').innerText = content.contexto_no || "Aquí tienes más información sobre lo que está ocurriendo actualmente...";
                document.getElementById('proposal-text').innerText = content.proposal;
                document.getElementById('proposal-impact').innerText = content.impact;
                document.getElementById('summary-topic').innerText = val.toUpperCase();
                nextStep(1);
            } else {
                alert("Tema no configurado");
            }
        }

        function nextStep(current) {
            document.getElementById(`step-${current}`).classList.remove('active');
            document.getElementById(`step-${current + 1}`).classList.add('active');
            const step = current + 1;
            // Evitar que la barra pase de largo visualmente si hay pasos intermedios no contados.
            document.getElementById('progress-fill').style.width = (step / 4) * 100 + '%';
            if (step <= 4) document.getElementById('step-counter').innerText = `Paso ${step} de 4`;
        }

        function showContextAndProceed() {
            // Ocultar paso 2
            document.getElementById(`step-2`).classList.remove('active');
            // Mostrar paso 2.5
            document.getElementById(`step-2-5`).classList.add('active');
        }

        function proceedFromContext() {
            // Ocultar 2.5 y pasar directo al 3
            document.getElementById(`step-2-5`).classList.remove('active');
            document.getElementById(`step-3`).classList.add('active');
            document.getElementById('progress-fill').style.width = (3 / 4) * 100 + '%';
            document.getElementById('step-counter').innerText = `Paso 3 de 4`;
        }

        function restartForm() {
            window.location.href = window.location.pathname;
        }

        async function finish() {
            const name = document.getElementById('name').value;
            const dni = document.getElementById('dni').value;
            const phone = document.getElementById('phone').value;
            let customTopic = '';

            if (userResponses.topic === 'Otros') {
                customTopic = document.getElementById('custom-topic').value;
                if (!customTopic) return alert("Por favor, escribe tu tema propuesto.");
            }

            if (!name || !phone) {
                return alert("Por favor, llena tu nombre y WhatsApp para continuar.");
            }
            if (dni && (dni.length !== 8 || isNaN(dni))) {
                return alert("Si ingresas tu DNI, asegúrate de que tenga 8 números.");
            }

            // Guardar en Django
            const response = await fetch('/guardar-participacion/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    name,
                    dni,
                    phone,
                    topic: userResponses.topic,
                    customTopic: customTopic
                })
            });

            if (response.ok) {
                // Generar mensaje estructurado para WhatsApp Business
                let msg = `Registro - Brigada Ciudadana\n\nHola Eduardo Herrera, soy *${name}*.\nQuiero apoyar tus propuestas sobre: *${userResponses.topic}*.`;
                if (dni && dni.trim() !== '') {
                    msg += `\nMi DNI es: ${dni}`;
                }

                const waUrl = `https://wa.me/51954124774?text=${encodeURIComponent(msg)}`;

                // Abrir WhatsApp
                const a = document.createElement('a');
                a.href = waUrl;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // Forzar foco en la ventana actual (por si acaso)
                window.focus();

                // Mostrar pantalla final con bono ONPE
                document.getElementById('step-4').innerHTML = `
                    <div class="text-center">
                        <i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
                        <h2 class="text-3xl font-extrabold mb-2 font-display text-green-500 italic">¡Gracias Chalaco!</h2>
                        <p class="text-gray-300 mb-8 text-sm">Tu registro ha sido enviado exitosamente.</p>
                        
                        <div class="bg-blue-900/40 border border-blue-500/30 p-6 rounded-2xl">
                            <h3 class="font-bold text-lg mb-2 text-white">¿Dónde te toca votar?</h3>
                            <p class="text-sm text-gray-300 mb-6">Consulta tu local de votación oficial directamente en la web de la ONPE usando tu DNI.</p>
                            <a href="https://consultaelectoral.onpe.gob.pe/" target="_blank"
                                class="inline-block w-full bg-blue-600 hover:bg-blue-700 py-4 rounded-xl font-bold uppercase text-white transition-colors shadow-lg">
                                Consultar Local ONPE
                            </a>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            } else {
                alert("Ocurrió un error al guardar tu participación.");
            }
        }
    </script>
</body>

</html>